! globals.f90
module globals
  use typy
  implicit none

  ! Time/progress helpers
  real(kind=rkind) :: tmp, tmp1, sim_time, start_time, end_time, time
  logical          :: www

  ! ---------- Node structure ----------
  type :: nodes_str
     real(kind=rkind), allocatable :: data(:,:)     ! (n_nodes,2): x,y
     logical,       allocatable    :: watershed(:)  ! mask if needed
     integer(kind=ikind)           :: kolik = 0
     real(kind=rkind), allocatable :: altitude(:)   ! elevation z
  end type nodes_str

  ! ---------- Hydrological balance (per element, per step) ----------
  type, public :: hydrobal_str
     integer(kind=ikind), dimension(2) :: inflowel = 0, outflowel = 0
     real(kind=rkind) :: deltas  = 0.0_rkind
     real(kind=rkind) :: inflow  = 0.0_rkind
     real(kind=rkind) :: outflow = 0.0_rkind
     real(kind=rkind) :: Li      = 0.0_rkind
     real(kind=rkind) :: ET      = 0.0_rkind
     real(kind=rkind) :: Qgw     = 0.0_rkind
     real(kind=rkind) :: Qsurf   = 0.0_rkind
  end type hydrobal_str

  ! ---------- Element structure ----------
  type :: elements_str
     integer(kind=ikind), allocatable :: data(:,:)      ! connectivity (nel,3)
     real(kind=rkind),    allocatable :: area(:)        ! element area
     integer(kind=ikind), allocatable :: material(:)    ! optional soil ID
     type(hydrobal_str),  allocatable :: hydrobal(:)    ! hydro state
     integer(kind=ikind)              :: kolik = 0      ! number of elements
     integer(kind=ikind), allocatable :: neighbours(:,:)! (nel,max_neigh)
     real(kind=rkind),    allocatable :: avgalt(:)      ! mean elevation
     real(kind=rkind),    allocatable :: overflow(:)    ! local generated overflow
  end type elements_str

  type(nodes_str)    :: nodes
  type(elements_str) :: elements

  ! Simulation time discretisation
  integer(kind=ikind), parameter :: n_days = 1
  integer(kind=ikind) :: CN, Julian_day , time_step
  real(kind=rkind) :: phi, as, bs, z, alpha, sigma, gsc, ccrop

  ! Element-based hydro inputs & outputs (time series)
  real(kind=rkind), allocatable :: precip(:,:), qinter(:,:), qout(:,:)
  real(kind=rkind), allocatable :: conduct(:,:), G(:,:), Tmax(:,:), Tmin(:,:), Tmean(:,:)
  real(kind=rkind), allocatable :: RHmax(:,:), RHmin(:,:), uz(:,:), soilcontent(:,:)

  real(kind=rkind), allocatable :: Qsurf_result(:,:), ET_flux(:,:), &
                                   L_result(:,:), Qgw_result(:,:), deltas(:,:)

  integer, parameter :: terminal = 6

  ! ---------- Configuration structure (kept from DRUtES style) ----------
  type, public :: configuration
    character(len=1)    :: run_dual
    character(len=1)    :: damped_newton
    integer(1)          :: dimen = 2
    integer(kind=ikind) :: mesh_type
    logical             :: adapt_observe
    logical             :: run_from_backup
    integer(kind=ikind) :: fnc_method
    real(kind=rkind)    :: fnc_discr_length
    integer(kind=ikind) :: it_method
    character(len=256)  :: name
    character(len=4096) :: fullname
    logical             :: rotsym = .false.
    logical             :: check4mass = .false.
  end type configuration

  type(configuration), public :: drutes_config

  ! ---------- New routing / storage globals ----------
  real(kind=rkind), allocatable :: storage(:)    ! [mm] surface/depression storage
  real(kind=rkind), allocatable :: capacity(:)   ! [mm] max local storage capacity
  real(kind=rkind), allocatable :: outlet_Q(:)   ! [mm] outlet discharge per time step

  integer(kind=ikind), allocatable :: downstream(:) ! downstream element ID (0 = outlet)
  integer(kind=ikind), allocatable :: flow_order(:) ! processing order (upstreamâ†’downstream)

  ! Number of time steps (set in initvals)
  integer(kind=ikind) :: nsteps = 0

end module globals
